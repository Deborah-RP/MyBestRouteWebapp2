{% extends 'base_map_dataTables.html' %} 
{% block add_css_block %}
    {% include "dualbox_css.html" %}
{% endblock %}
{% block page_block %}

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h2>{{ form.header }}<h2>
                </div>
                <div class="panel-body">
                        
                    <div class="dataTable_wrapper">
                        <table class="table table-striped table-bordered table-hover" id="CURDTable">
                        </table>
                        <!-- /.table-responsive -->                                
                    </div>
                            <!-- /.dataTable_wrapper -->                            
                    {% include "create_plan_modal.html" %}
                    {% include "edit_plan_modal.html" %}
                    {% include "task_map_modal.html" %}
                        
                    
                    <input type='hidden' value='{{form.action}}' id='tb_ajax_url'>
                    <input type='hidden' value='{{form.tb_buttons}}' id='tb_buttons'>
                    <input type='hidden' value='{{form.ajax_search_url}}' id='ajax_search_url'>
                    <input type='hidden' value='{{form.ajax_search_get_fields}}' id='ajax_search_get_fields'>   
                    <input type='hidden' value='{{form.ajax_search_set_fields}}' id='ajax_search_set_fields'>                   

                    <input type='hidden' value='{{form.template_search_url}}' id='template_search_url'>
                    <input type='hidden' value='{{form.template_search_get_fields}}' id='template_search_get_fields'>   
                    <input type='hidden' value='{{form.template_search_set_fields}}' id='template_search_set_fields'>                        
                </div>
                <!-- /.panel-body -->

                {% include 'dndexcel_modal.html' %}
                {% include "upload_task_modal.html" %}
                <div class="load_icon"><!-- Place at bottom of page --></div>    
            </div>
            <!-- class="panel" -->
        </div>
         <!--class="col-lg-12" -->
    </div>
    <!-- /.row -->            
</div>
<!--/.container-fluid-->
{% endblock %} 

{% block javascript_block %}
        
        {%include "dualbox_js.html" %}

<script>
    function init_page() {
        var $doc = $(document);
        $body = $("body");
        $doc.on({
            ajaxStart: function () {
                $body.addClass("ajax_load");
            },
            ajaxStop: function () {
                $body.removeClass("ajax_load");
            },
        });
        var tb_params = {};
        tb_params.create_modal_id = "#create_modal"
        tb_params.edit_modal_id = "#edit_modal";
        tb_params.tb_id = "#CURDTable";
        tb_params.ajax = $("#tb_ajax_url").val();
        tb_params.dt_source = $("#dt_source").val();
        tb_params.dnd_id = "#dndPanel";
        //print_obj(tb_params.ajax);
        //tb_params.order = [ 0, 'asc' ];
        tb_params.dom = '<"clear">flritTp';
        tb_params.tableTools = {};
        tb_params.tableTools.tb_buttons = $("#tb_buttons").val();
        tb_params.tableTools.aButtons = init_tb_btn(tb_params);
        $(tb_params.dnd_id).show();
        init_tb_cols(tb_params)

        $('#CURDTable tbody').on('click', 'tr', function () {
            $(this).toggleClass('selected');
            //console.log( table.row( this ).data() );
        });

        $("form").each(function(){
            $(this).validator().submit(function (e) {   
                if (e.isDefaultPrevented()) {
                    //console.log("Validation failed!");
                    return;
                } else {
                    form_async_submit($(this), e, null);
                }
            });
        });

        var pageVar = {};
        var upload_modal_id = "#upload_modal";
        //Register buttons with the show event
        $("#setOptBtn").click(function () {
            $(upload_modal_id).modal('show');
        });
        $dnd_obj = $("#fileDnD");
        $file_selected = $("#fileSelected");
        
        
        //Register dynamic add button event
        $(".addFieldBtn").click(function(){
            create_new_field($(this));
        });
        
        //Add the DualBoxList to Select Mulitple
        $('select').filter('[name="driver_set"]').
        bootstrapDualListbox({
            nonSelectedListLabel: 'Non-selected Drivers',
            selectedListLabel: 'Selected Drivers',
            preserveSelectionOnMove: 'moved',
            moveOnSelect: false,});
        
        $('select').filter('[name="task_set"]').
        bootstrapDualListbox({
            nonSelectedListLabel: 'Non-selected Tasks',
            selectedListLabel: 'Selected Tasks',
            preserveSelectionOnMove: 'moved',
            moveOnSelect: false,});        
        
        var $current_upload_form, task_set_field_list;
        var task_set_id = "#task_set";
        
        //Identify the 
        $(".upload_task_set").click(function(){
            $current_upload_form = $(this).parents('form');
            $("#dndexcel_modal").modal('show');
        });
        
        
        task_set_field_list = [];
        task_set_field_list.push($(tb_params.create_modal_id).find(task_set_id));
        task_set_field_list.push($(tb_params.edit_modal_id).find(task_set_id));
        //print_obj(task_set_field_list);
        
        $doc.on({
            'dragenter dragover drop': handleDragenter,
            'm_sheet_warning:on': function () {
                $('#multiSheetWarning').show();
            },
            'm_sheet_warning:off': function () {
                $('#multiSheetWarning').hide();
            },
            'read_xls:start': function (e, bar_text) {
                $("#readData").update_progress_bar(65, bar_text,
                    "progress-bar-warning progress-bar-striped");
            },
            'read_xls:stop': function (e) {
                $("#readData").update_progress_bar(100, "Read data ",
                    "progress-bar-info");
            },
            'add_xls_option': function (e, xlf_header, ignore_headers) {
                $(upload_modal_id).add_select_options(xlf_header, ignore_headers);
            },
            'process_wb:stop': function(e, upload_data){
                $(upload_modal_id).modal('hide');
                var ajax_data = {
                    formType: 'async_upload', 
                    upload_data: upload_data,        
                };
                var posting = $.post("/team_user/task", ajax_data);
                
                //Reset the options field after upload finished. 
                posting.done(function(data)
                {
                    if (data.status === true) {
                        if (data.message) {
                            bootbox.alert(data.message, function(){
                                $(upload_modal_id).modal('hide');
                                $("#dndexcel_modal").modal('hide');
                        
                                //Ajax to retrieve all the task
                                var post_data = {formType: 'async_query_all_json'}
                            
                                var posting =$.post('/team_user/task', post_data);

                                var all_task;
                                var current_task_set_field=$current_upload_form.find(task_set_id);

                                posting.done(function(data){
                                    all_task = data.data;
                                    upload_data = JSON.parse(upload_data);
                                    refresh_task_set_options(upload_data,
                                            all_task,
                                            task_set_field_list);
                                });                                  
                            });
                        }
                    }
                else {
                    bootbox.alert(data.message);
                }
                });
            },
        });
        
        $dnd_obj.on({
            'dragenter': handleDragenter,
            'dragover': function (e) {
                $(this).addClass('hover');
                handleDragenter(e);
            },
        });        

        var drop_select_param = {
            opt_panel_id: "#upload_modal",
            confirm_opt_id: "#uploadBtn",
            confirm_callback_func: filter_wb_to_json,
        };
        $dnd_obj.on('drop', drop_select_param, handleDropSelect);
        $file_selected.on('change', drop_select_param, handleDropSelect);
        
        var map_opts = {
            div_id: "osm_task_map",
            center: [1.365629, 103.810896],
            zoom: 12,
        };
        
        /*$("body").on("shown.bs.tab", "#show_task_map", function() {
            var map = create_osmap(map_opts);
            map.invalidateSize(false);
        });*/
        
        $(".map_task_set").click(function(){
            //Create the map
            var map = create_osmap(map_opts);
            $("#task_map_modal").modal('show');
            map.invalidateSize(false);
            
            //Get the current form
            $current_form = $(this).parents('form');
            
            //Get the task field
            var task_set_field = $current_form.find(task_set_id);
            
            //Get the tasks selected status
            var task_status = {};
            $current_form.find(task_set_id+" option").each(function(name, val){
                var entity_id = $(this).val();
                task_status[entity_id] = $(this).prop('selected');
            });

            //Get all the tasks
            var post_data = {formType: 'async_query_all_json'}
            var posting = $.post('/team_user/task', post_data);
            var all_task;

            posting.done(function(data){
                all_task = data.data;
                //print_obj(data);

                map.on("boxzoomend", function(e){
                /*
                 For all the markers within the box
                 1. Change the icon
                 2. Change the options 'selected' status
                */
                for (var idx=0; idx<all_task.length; idx++){
                    var this_task = all_task[idx];
                    if (e.boxZoomBounds.contains(this_task.task_latlng)) {
                        this_task.selected = !this_task.selected;
                        var task_icon = create_task_icon(this_task.selected);
                        this_task.marker.setIcon(task_icon);
                        var entity_id = this_task._entity_id;
                        var sel_query = "option[value='"+entity_id+"']";
                        task_set_field.find(sel_query).prop('selected', this_task.selected);
                        }
                    task_set_field.bootstrapDualListbox('refresh')
                    }
                });
                       
                /*
                    For each task:
                    1. Get the 'selected' status
                    2. Create icon
                    3. Add the marker to the map
                */
                for (var idx=0; idx<all_task.length; idx++){
                    var each_task = all_task[idx];
                    var entity_id = each_task._entity_id;
                    var task_latlng = each_task.task_latlng;
                    var task_selected = task_status[entity_id];
                    var task_icon = create_task_icon(task_selected);
                    //console.log("latlng: " + task_latlng + " task_selected: " + task_selected);
                    all_task[idx].marker = L.marker(task_latlng, {icon: task_icon}).addTo(map);
                    all_task[idx].selected = task_selected;
                }
            });
        });
    }

    window.onload = init_page;
</script>
        
{% endblock %} 