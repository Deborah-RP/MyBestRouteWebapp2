{% extends 'base_dataTables.html' %} 

{% block page_block %}

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h2>{{ form.header }}<h2>
                </div>
                <div class="panel-body">
                        
                    <div class="dataTable_wrapper">
                        <table class="table table-striped table-bordered table-hover" id="CURDTable">
                        </table>
                        <!-- /.table-responsive -->                                
                    </div>
                            <!-- /.dataTable_wrapper -->                            
                    {% include "create_ba_modal.html" %}
                    {% include "edit_modal.html" %}
                        
                    
                    <input type='hidden' value='{{form.action}}' id='tb_ajax_url'>
                    <input type='hidden' value='{{form.tb_buttons}}' id='tb_buttons'>
                    <input type='hidden' value='{{form.ajax_search_url}}' id='ajax_search_url'>
                    <input type='hidden' value='{{form.ajax_search_get_fields}}' id='ajax_search_get_fields'>   
                    <input type='hidden' value='{{form.ajax_search_set_fields}}' id='ajax_search_set_fields'>                   

                    <input type='hidden' value='{{form.template_search_url}}' id='template_search_url'>
                    <input type='hidden' value='{{form.template_search_get_fields}}' id='template_search_get_fields'>   
                    <input type='hidden' value='{{form.template_search_set_fields}}' id='template_search_set_fields'>                        
                </div>
                <!-- /.panel-body -->

                {% include 'dndexcel.html' %}
                {% include "upload_modal.html" %}
                <div class="load_icon"><!-- Place at bottom of page --></div>    
            </div>
            <!-- class="panel" -->
        </div>
         <!--class="col-lg-12" -->
    </div>
    <!-- /.row -->            
</div>
<!--/.container-fluid-->
{% endblock %} 

{% block javascript_block %}
<script>
    function init_page() {
        var $doc = $(document);
        $body = $("body");
        $doc.on({
            ajaxStart: function () {
                $body.addClass("ajax_load");
            },
            ajaxStop: function () {
                $body.removeClass("ajax_load");
            },
        });
        var tb_params = {};
        tb_params.create_modal_id = "#create_modal"
        tb_params.edit_modal_id = "#edit_modal";
        tb_params.tb_id = "#CURDTable";
        tb_params.ajax = $("#tb_ajax_url").val();
        tb_params.dt_source = $("#dt_source").val();
        tb_params.dnd_id = "#dndPanel";
        //print_obj(tb_params.ajax);
        //tb_params.order = [ 0, 'asc' ];
        tb_params.dom = '<"clear">flritTp';
        tb_params.tableTools = {};
        tb_params.tableTools.tb_buttons = $("#tb_buttons").val();
        tb_params.tableTools.aButtons = init_tb_btn(tb_params);

        init_tb_cols(tb_params)

        $('#CURDTable tbody').on('click', 'tr', function () {
            $(this).toggleClass('selected');
            //console.log( table.row( this ).data() );
        });

        $("form").each(function(){
            $(this).validator().submit(function (e) {   
                if (e.isDefaultPrevented()) {
                    //console.log("Validation failed!");
                    return;
                } else {
                    form_async_submit($(this), e, null);
                }
            });
        });

        var pageVar = {};
        //Register buttons with the show event
        $("#setOptBtn").click(function () {
            $("#upload_modal").modal('show');
        });
        $dnd_obj = $("#fileDnD");
        $file_selected = $("#fileSelected");
        
        
        //Register dynamic add button event
        $(".addFieldBtn").click(function(){
            create_new_field($(this));
        });
        
        $doc.on({
            'dragenter dragover drop': handleDragenter,
            'm_sheet_warning:on': function () {
                $('#multiSheetWarning').show();
            },
            'm_sheet_warning:off': function () {
                $('#multiSheetWarning').hide();
            },
            'read_xls:start': function (e, bar_text) {
                $("#readData").update_progress_bar(65, bar_text,
                    "progress-bar-warning progress-bar-striped");
            },
            'read_xls:stop': function (e) {
                $("#readData").update_progress_bar(100, "Read data ",
                    "progress-bar-info");
            },
            'add_xls_option': function (e, xlf_header, ignore_headers) {
                $("#upload_modal").add_select_options(xlf_header, ignore_headers);
            },
            'process_wb:stop': function(e, upload_data){
                $("#upload_modal").modal('hide');
                var ajax_data = {
                    formType: 'async_upload', 
                    upload_data: upload_data,        
                };
                json_async_submit(tb_params, ajax_data);
            },
        });
        
        $dnd_obj.on({
            'dragenter': handleDragenter,
            'dragover': function (e) {
                $(this).addClass('hover');
                handleDragenter(e);
            },
        });        

        var drop_select_param = {
            opt_panel_id: "#upload_modal",
            confirm_opt_id: "#uploadBtn",
            confirm_callback_func: filter_wb_to_json,
        };
        $dnd_obj.on('drop', drop_select_param, handleDropSelect);
        $file_selected.on('change', drop_select_param, handleDropSelect);
    }

    window.onload = init_page;
</script>
        
{% endblock %} 